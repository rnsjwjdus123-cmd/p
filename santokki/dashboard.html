<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Santokki Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root{
  --white:#fafaf9;--off-white:#f5f5f4;
  --gray-100:#e7e5e4;--gray-200:#d6d3d1;--gray-300:#a8a29e;--gray-400:#78716c;--gray-500:#57534e;--gray-600:#44403c;--gray-700:#292524;--gray-800:#1c1917;--gray-900:#0c0a09;
  --green-50:#f0f7f4;--green-100:#d9ebe3;--green-200:#b3d7c7;--green-300:#7eb99e;--green-400:#4d9b73;--green-500:#2d7a52;--green-600:#1e5c3a;--green-700:#153d28;
  --accent:#1e5c3a;--accent-light:#f0f7f4;--accent-hover:#153d28;
  --red:#dc2626;--orange:#ea580c;--text:#1c1917;--text2:#57534e;--text3:#a8a29e;
  --border:#e7e5e4;--radius:8px;
  --font-display:'Cormorant Garamond',Georgia,serif;
  --font-body:'Outfit',-apple-system,sans-serif;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:var(--font-body);font-weight:400;color:var(--text);background:var(--white);line-height:1.6;-webkit-font-smoothing:antialiased}

/* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.layout{display:flex;min-height:100vh}
.sidebar{width:220px;background:#fff;border-right:1px solid var(--border);padding:24px 16px;position:fixed;height:100vh;overflow-y:auto;z-index:10}
.sidebar .logo{display:flex;align-items:center;gap:8px;margin-bottom:28px;padding:0 8px}
.sidebar .logo-icon{width:28px;height:28px;display:flex;align-items:center;justify-content:center}
.sidebar .logo-icon .ear{position:absolute;width:6px;height:12px;background:var(--green-600);border-radius:6px 6px 2px 2px}
.sidebar .logo-icon .ear.l{transform:rotate(-18deg) translate(-5px, -2px)}
.sidebar .logo-icon .ear.r{transform:rotate(18deg) translate(5px, -2px)}
.sidebar .logo span{font-family:var(--font-display);font-size:1.35rem;font-weight:600;color:var(--gray-800);letter-spacing:.02em}
.sidebar nav a{display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:var(--radius);color:var(--gray-500);text-decoration:none;font-size:.82rem;font-weight:500;transition:.15s;margin-bottom:1px}
.sidebar nav a:hover{background:var(--off-white);color:var(--gray-700)}
.sidebar nav a.active{background:var(--accent-light);color:var(--accent)}
.sidebar .sep{height:1px;background:var(--border);margin:14px 0}
.main{flex:1;margin-left:220px;padding:28px 36px 60px;max-width:calc(100% - 220px)}

/* â”€â”€ Top Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px}
.topbar h1{font-family:var(--font-display);font-size:1.6rem;font-weight:600;color:var(--gray-800)}
.topbar .meta{display:flex;align-items:center;gap:14px}
.badge{display:inline-flex;align-items:center;gap:5px;padding:4px 12px;border-radius:20px;font-size:.7rem;font-weight:600;letter-spacing:.03em}
.badge.live{background:var(--accent-light);color:var(--accent);border:1px solid var(--green-200)}
.badge.live::before{content:'';width:6px;height:6px;border-radius:50%;background:var(--accent);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

/* â”€â”€ Filters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.filter-bar{display:flex;gap:6px;margin-bottom:24px}
.filter-btn{padding:6px 16px;border-radius:20px;border:1px solid var(--border);background:#fff;color:var(--text2);font-size:.78rem;font-weight:500;cursor:pointer;transition:.15s;font-family:var(--font-body)}
.filter-btn:hover{border-color:var(--gray-300);color:var(--gray-700)}
.filter-btn.active{border-color:var(--accent);color:var(--accent);background:var(--accent-light)}

/* â”€â”€ KPI Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:24px}
.kpi{background:#fff;border:1px solid var(--border);border-radius:var(--radius);padding:18px 22px;position:relative;transition:box-shadow .2s}
.kpi:hover{box-shadow:0 2px 12px rgba(0,0,0,.04)}
.kpi .top-line{height:2px;border-radius:2px;margin-bottom:14px}
.kpi:nth-child(1) .top-line{background:var(--green-500)}
.kpi:nth-child(2) .top-line{background:var(--green-300)}
.kpi:nth-child(3) .top-line{background:var(--orange)}
.kpi:nth-child(4) .top-line{background:var(--green-600)}
.kpi .label{font-size:.72rem;color:var(--text3);font-weight:500;margin-bottom:6px;text-transform:uppercase;letter-spacing:.05em}
.kpi .value{font-family:var(--font-display);font-size:2rem;font-weight:600;color:var(--gray-800);letter-spacing:-.02em}
.kpi .sub{font-size:.72rem;margin-top:4px;font-weight:500}

/* â”€â”€ Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:16px}
.card{background:#fff;border:1px solid var(--border);border-radius:var(--radius);padding:22px;transition:box-shadow .2s}
.card:hover{box-shadow:0 2px 12px rgba(0,0,0,.04)}
.card h3{font-family:var(--font-body);font-size:.85rem;font-weight:600;color:var(--gray-700);margin-bottom:3px}
.card .desc{font-size:.72rem;color:var(--text3);margin-bottom:18px}
.card canvas{max-height:260px}

/* â”€â”€ Alert â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.alert-banner{background:#fef2f2;border:1px solid #fecaca;border-radius:var(--radius);padding:12px 18px;margin-bottom:16px;display:flex;align-items:center;gap:10px;font-size:.82rem;color:var(--red);display:none}
.alert-banner.show{display:flex}
.alert-banner strong{font-weight:600}

/* â”€â”€ Funnel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.funnel-step{display:flex;align-items:center;gap:14px;padding:10px 0}
.funnel-bar-wrap{flex:1;height:32px;border-radius:6px;overflow:hidden;background:var(--off-white)}
.funnel-bar{height:100%;border-radius:6px;display:flex;align-items:center;padding:0 14px;font-size:.75rem;font-weight:600;color:#fff}
.funnel-pct{width:56px;text-align:right;font-size:.85rem;font-weight:700}
.funnel-label{width:130px;font-size:.75rem;color:var(--text2)}
.funnel-drop{text-align:center;font-size:.68rem;color:var(--text3);padding:1px 0}

/* â”€â”€ Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.data-table{width:100%;border-collapse:collapse;font-size:.8rem}
.data-table th{text-align:left;color:var(--text3);font-weight:500;padding:10px 12px;border-bottom:1px solid var(--border);font-size:.68rem;text-transform:uppercase;letter-spacing:.05em}
.data-table td{padding:10px 12px;border-bottom:1px solid var(--gray-100)}
.data-table tr:hover td{background:var(--green-50)}
.status-badge{padding:3px 10px;border-radius:12px;font-size:.68rem;font-weight:600}
.status-badge.sent{background:#dcfce7;color:#166534}
.status-badge.pending{background:#fff7ed;color:var(--orange)}

/* â”€â”€ Loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.loading-overlay{position:fixed;inset:0;background:var(--white);display:flex;align-items:center;justify-content:center;z-index:999;transition:opacity .3s}
.loading-overlay.hidden{opacity:0;pointer-events:none}
.spinner{width:36px;height:36px;border:3px solid var(--gray-100);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media(max-width:1100px){.kpi-grid{grid-template-columns:repeat(2,1fr)}.grid-2,.grid-3{grid-template-columns:1fr}}
@media(max-width:768px){.sidebar{display:none}.main{margin-left:0;padding:16px;max-width:100%}}
</style>
</head>
<body>

<div class="loading-overlay" id="loadingOverlay">
  <div style="text-align:center">
    <div class="spinner" style="margin:0 auto 16px"></div>
    <div style="color:var(--text3);font-size:14px">Firestore ë°ì´í„° ë¡œë”© ì¤‘...</div>
  </div>
</div>

<div class="layout">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo">
      <span>Santokki</span>
    </div>
    <nav>
      <a href="#overview" class="active" onclick="scrollTo('overview')">ğŸ“Š ì „ì²´ í˜„í™©</a>
      <a href="#funnel" onclick="scrollTo('funnel')">ğŸ”½ í¼ë„ ë¶„ì„</a>
      <a href="#scent" onclick="scrollTo('scent')">ğŸŒ¸ í–¥ í”„ë¡œí•„</a>
      <a href="#products" onclick="scrollTo('products')">ğŸ›ï¸ ì œí’ˆ ë§¤ì¹­</a>
      <a href="#demographics" onclick="scrollTo('demographics')">ğŸ‘¥ ì¸êµ¬í†µê³„</a>
      <a href="#space" onclick="scrollTo('space')">ğŸ  ê³µê°„ ì„ í˜¸</a>
      <a href="#timeline" onclick="scrollTo('timeline')">ğŸ“ˆ ì°¸ì—¬ ì¶”ì´</a>
      <a href="#feed" onclick="scrollTo('feed')">âš¡ ì‹¤ì‹œê°„ í”¼ë“œ</a>
      <div class="sep"></div>
      <a href="#" onclick="loadData()" style="color:var(--accent)">ğŸ”„ ë°ì´í„° ìƒˆë¡œê³ ì¹¨</a>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="main">
    <!-- Top Bar -->
    <div class="topbar">
      <h1>ë§ˆì¼€í„° ëŒ€ì‹œë³´ë“œ</h1>
      <div class="meta">
        <span class="badge live">â— LIVE</span>
        <span id="lastUpdate" style="font-size:.78rem;color:var(--text3)">ìµœê·¼ ì—…ë°ì´íŠ¸: --</span>
      </div>
    </div>

    <!-- Date Filter -->
    <div class="filter-bar">
      <button class="filter-btn" onclick="setFilter('today', this)">ì˜¤ëŠ˜</button>
      <button class="filter-btn" onclick="setFilter('7d', this)">ìµœê·¼ 7ì¼</button>
      <button class="filter-btn active" onclick="setFilter('30d', this)">ìµœê·¼ 30ì¼</button>
      <button class="filter-btn" onclick="setFilter('all', this)">ì „ì²´</button>
    </div>

    <!-- Alert Banner -->
    <div class="alert-banner" id="alertBanner">
      âš ï¸ <strong>DM ë¯¸ë°œì†¡ <span id="alertCount">0</span>ê±´</strong> â€” n8n ì›Œí¬í”Œë¡œìš°ë¥¼ í™•ì¸í•˜ì„¸ìš”
    </div>

    <!-- â•â•â• Section: KPI â•â•â• -->
    <section id="overview">
      <div class="kpi-grid">
        <div class="kpi">
          <div class="top-line"></div>
          <div class="label">í€´ì¦ˆ ì´ ì°¸ì—¬ì</div>
          <div class="value" id="kpiTotal">--</div>
          <div class="sub" id="kpiTotalSub" style="color:var(--green-500)">ë¡œë”© ì¤‘...</div>
        </div>
        <div class="kpi">
          <div class="top-line"></div>
          <div class="label">DM ë°œì†¡ ì™„ë£Œ</div>
          <div class="value" id="kpiSent">--</div>
          <div class="sub" id="kpiSentSub" style="color:var(--green-500)">--</div>
        </div>
        <div class="kpi">
          <div class="top-line"></div>
          <div class="label">ë°œì†¡ ëŒ€ê¸° ì¤‘</div>
          <div class="value" id="kpiPending">--</div>
          <div class="sub" id="kpiPendingSub" style="color:var(--orange)">--</div>
        </div>
        <div class="kpi">
          <div class="top-line"></div>
          <div class="label">í”„ë¡œëª¨ì½”ë“œ ë°œê¸‰</div>
          <div class="value" id="kpiPromo">--</div>
          <div class="sub" id="kpiPromoSub" style="color:var(--text3)">--</div>
        </div>
      </div>
    </section>

    <!-- â•â•â• Section: Funnel â•â•â• -->
    <section id="funnel" style="margin-bottom:20px">
      <div class="card">
        <h3>ğŸ”½ í¼ë„ ë¶„ì„</h3>
        <div class="desc">í€´ì¦ˆ ì™„ë£Œë¶€í„° DM ë°œì†¡ê¹Œì§€ì˜ ì „í™˜ í˜„í™© (ManyChat ì—°ë™ ì‹œ ìƒë‹¨ í¼ë„ ì¶”ê°€ ì˜ˆì •)</div>
        <div id="funnelChart"></div>
      </div>
    </section>

    <!-- â•â•â• Section: Scent Profile â•â•â• -->
    <section id="scent">
      <div class="grid-2">
        <div class="card">
          <h3>ğŸŒ¸ í–¥ í”„ë¡œí•„ ë¶„í¬</h3>
          <div class="desc">top_scent ê¸°ì¤€ ì „ì²´ ë¹„ìœ¨</div>
          <canvas id="scentPie"></canvas>
        </div>
        <div class="card">
          <h3>ğŸ“Š í–¥ í”„ë¡œí•„ ì ìˆ˜ ë¶„í¬</h3>
          <div class="desc">í‰ê·  ì ìˆ˜ ë¹„êµ (0~37.5ì )</div>
          <canvas id="scentBar"></canvas>
        </div>
      </div>
    </section>

    <!-- â•â•â• Section: Products â•â•â• -->
    <section id="products" style="margin-bottom:20px">
      <div class="grid-2">
        <div class="card">
          <h3>ğŸ›ï¸ ì œí’ˆë³„ ë§¤ì¹­ ë­í‚¹</h3>
          <div class="desc">ì¶”ì²œ íšŸìˆ˜ ê¸°ì¤€ ìƒìœ„ ì œí’ˆ</div>
          <canvas id="productBar"></canvas>
        </div>
        <div class="card">
          <h3>ğŸ“¦ ì¹´í…Œê³ ë¦¬ë³„ ë¹„ì¤‘</h3>
          <div class="desc">ì œí’ˆ ìœ í˜•ë³„ ë§¤ì¹­ ë¹„ìœ¨</div>
          <canvas id="categoryDoughnut"></canvas>
        </div>
      </div>
    </section>

    <!-- â•â•â• Section: Demographics â•â•â• -->
    <section id="demographics">
      <div class="grid-3">
        <div class="card">
          <h3>ğŸ‘¥ ì„±ë³„ ë¶„í¬</h3>
          <div class="desc">basic_info.gender ê¸°ì¤€</div>
          <canvas id="genderPie"></canvas>
        </div>
        <div class="card">
          <h3>ğŸ‚ ì—°ë ¹ëŒ€ ë¶„í¬</h3>
          <div class="desc">basic_info.age_group ê¸°ì¤€</div>
          <canvas id="agePie"></canvas>
        </div>
        <div class="card">
          <h3>ğŸŒ¸ ì„±ë³„ Ã— í–¥ í”„ë¡œí•„</h3>
          <div class="desc">ì„¸ê·¸ë¨¼íŠ¸ë³„ ì·¨í–¥ ì°¨ì´</div>
          <canvas id="genderScentBar"></canvas>
        </div>
      </div>
    </section>

    <!-- â•â•â• Section: Space â•â•â• -->
    <section id="space">
      <div class="grid-2">
        <div class="card">
          <h3>ğŸ  ê³µê°„ ì„ í˜¸ë„</h3>
          <div class="desc">selected_space ê¸°ì¤€ ë¹„ìœ¨</div>
          <canvas id="spacePie"></canvas>
        </div>
        <div class="card">
          <h3>ğŸ  ê³µê°„ë³„ ì¸ê¸° í–¥</h3>
          <div class="desc">ê³µê°„ Ã— í–¥ í”„ë¡œí•„ í¬ë¡œìŠ¤ ë¶„ì„</div>
          <canvas id="spaceBar"></canvas>
        </div>
      </div>
    </section>

    <!-- â•â•â• Section: Timeline â•â•â• -->
    <section id="timeline" style="margin-bottom:20px">
      <div class="card">
        <h3>ğŸ“ˆ ì¼ë³„ ì°¸ì—¬ ì¶”ì´</h3>
        <div class="desc">created_at ê¸°ì¤€ ì¼ë³„ í€´ì¦ˆ ì™„ë£Œ ìˆ˜</div>
        <canvas id="timelineChart" style="max-height:320px"></canvas>
      </div>
    </section>

    <!-- â•â•â• Section: Live Feed â•â•â• -->
    <section id="feed">
      <div class="card">
        <h3>âš¡ ì‹¤ì‹œê°„ ì°¸ì—¬ í”¼ë“œ</h3>
        <div class="desc">ìµœê·¼ í€´ì¦ˆ ì™„ë£Œ ê¸°ë¡ (ìµœëŒ€ 50ê±´)</div>
        <div style="overflow-x:auto;margin-top:12px">
          <table class="data-table" id="feedTable">
            <thead>
              <tr><th>ì‹œê°</th><th>Subscriber</th><th>ì„±ë³„</th><th>ì—°ë ¹ëŒ€</th><th>ê³µê°„</th><th>í–¥ ê²°ê³¼</th><th>ì¶”ì²œ ì œí’ˆ</th><th>DM ìƒíƒœ</th></tr>
            </thead>
            <tbody id="feedBody">
              <tr><td colspan="8" style="text-align:center;color:var(--text3);padding:40px">ë°ì´í„° ë¡œë”© ì¤‘...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

  </main>
</div>

<script>
// â•â•â• Chart.js Global Defaults (Santokki Style) â•â•â•
Chart.defaults.font.family = "'Outfit', sans-serif";
Chart.defaults.font.size = 12;
Chart.defaults.color = '#78716c';

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Firebase Init
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const firebaseConfig = {
  apiKey: "AIzaSyA6a7I2yv1A4dvlbqpI9IgleYAdosZkn3c",
  authDomain: "santokki-f7c72.firebaseapp.com",
  projectId: "santokki-f7c72",
  storageBucket: "santokki-f7c72.firebasestorage.app",
  messagingSenderId: "186899981689",
  appId: "1:186899981689:web:25baaacb9ee3efa534fba8"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Scent Configuration
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SCENT_LABELS = ['FLORAL', 'GREEN', 'FRESH', 'WOODY_INK', 'WARMING'];
const SCENT_DISPLAY = ['ğŸŒ¸ Floral', 'ğŸŒ² Green', 'ğŸŒŠ Fresh', 'ğŸ–¤ Woody/Ink', 'ğŸ”¥ Warming'];
const SCENT_COLORS = ['#d4a0b9', '#4d9b73', '#6ba3be', '#8b7bb5', '#c8875f'];
const SCENT_BG = ['#d4a0b933', '#4d9b7333', '#6ba3be33', '#8b7bb533', '#c8875f33'];

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// State
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let allDocs = [];
let filteredDocs = [];
let currentFilter = '30d';
let charts = {};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Data Loading
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadData() {
  try {
    const snapshot = await db.collection('quiz_results')
      .orderBy('created_at', 'desc')
      .get();

    allDocs = snapshot.docs.map(doc => {
      const d = doc.data();
      return { id: doc.id, ...d };
    });

    applyFilter();
    document.getElementById('lastUpdate').textContent =
      'ìµœê·¼ ì—…ë°ì´íŠ¸: ' + new Date().toLocaleString('ko-KR');
  } catch (err) {
    console.error('Firestore load error:', err);
    document.getElementById('loadingOverlay').classList.add('hidden');
    alert('Firestore ì—°ê²° ì‹¤íŒ¨: ' + err.message + '\n\nFirestore Security Rulesì—ì„œ quiz_results ì½ê¸° ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”.');
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Filter
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setFilter(f, btn) {
  currentFilter = f;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  applyFilter();
}

function applyFilter() {
  const now = new Date();
  let cutoff = null;
  if (currentFilter === 'today') {
    cutoff = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  } else if (currentFilter === '7d') {
    cutoff = new Date(now - 7 * 86400000);
  } else if (currentFilter === '30d') {
    cutoff = new Date(now - 30 * 86400000);
  }
  // 'all' â†’ cutoff stays null

  if (cutoff) {
    filteredDocs = allDocs.filter(d => {
      const dt = d.created_at ? new Date(d.created_at) : null;
      return dt && dt >= cutoff;
    });
  } else {
    filteredDocs = [...allDocs];
  }

  renderAll();
  document.getElementById('loadingOverlay').classList.add('hidden');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Render All
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAll() {
  renderKPI();
  renderFunnel();
  renderScentCharts();
  renderProductCharts();
  renderDemographics();
  renderSpace();
  renderTimeline();
  renderFeed();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Module 1: KPI
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderKPI() {
  const total = filteredDocs.length;
  const sent = filteredDocs.filter(d => d.dm_sent === true).length;
  const pending = total - sent;
  const promo = filteredDocs.filter(d => d.promo_code).length;

  const rate = total > 0 ? ((sent / total) * 100).toFixed(1) : 0;

  document.getElementById('kpiTotal').textContent = total.toLocaleString();
  document.getElementById('kpiSent').textContent = sent.toLocaleString();
  document.getElementById('kpiPending').textContent = pending.toLocaleString();
  document.getElementById('kpiPromo').textContent = promo.toLocaleString();

  // Today counts for sub
  const today = new Date();
  const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());
  const todayDocs = allDocs.filter(d => d.created_at && new Date(d.created_at) >= todayStart);

  document.getElementById('kpiTotalSub').innerHTML = todayDocs.length > 0
    ? `â–² ${todayDocs.length} ì˜¤ëŠ˜`
    : 'ì˜¤ëŠ˜ 0ê±´';
  document.getElementById('kpiSentSub').innerHTML = `${rate}% ì™„ë£Œìœ¨`;
  document.getElementById('kpiPendingSub').innerHTML = pending > 0
    ? `â³ ${pending}ê±´ ì²˜ë¦¬ ì¤‘`
    : `âœ… ëª¨ë‘ ë°œì†¡`;
  document.getElementById('kpiPromoSub').innerHTML = `SANTOKKI-XXXX-15OFF`;

  // Alert
  const alertEl = document.getElementById('alertBanner');
  if (pending > 5) {
    alertEl.classList.add('show');
    document.getElementById('alertCount').textContent = pending;
  } else {
    alertEl.classList.remove('show');
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Module 2: Funnel
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFunnel() {
  const total = filteredDocs.length;
  const sent = filteredDocs.filter(d => d.dm_sent === true).length;
  const pct = total > 0 ? Math.round(sent / total * 100) : 0;

  document.getElementById('funnelChart').innerHTML = `
    <div class="funnel-step" style="opacity:.45"><div class="funnel-label">ëŒ“ê¸€ í‚¤ì›Œë“œ ì‘ì„±</div><div class="funnel-bar-wrap"><div class="funnel-bar" style="width:100%;background:var(--gray-200);color:var(--text3);font-style:italic">(ManyChat ì—°ë™ í›„)</div></div><div class="funnel-pct" style="color:var(--text3)">â€”</div></div>
    <div class="funnel-drop">â†“</div>
    <div class="funnel-step" style="opacity:.45"><div class="funnel-label">í€´ì¦ˆ ë§í¬ DM ìˆ˜ì‹ </div><div class="funnel-bar-wrap"><div class="funnel-bar" style="width:100%;background:var(--gray-200);color:var(--text3);font-style:italic">(ManyChat ì—°ë™ í›„)</div></div><div class="funnel-pct" style="color:var(--text3)">â€”</div></div>
    <div class="funnel-drop">â†“</div>
    <div class="funnel-step"><div class="funnel-label">í€´ì¦ˆ ì™„ë£Œ</div><div class="funnel-bar-wrap"><div class="funnel-bar" style="width:100%;background:var(--green-500)">${total.toLocaleString()}ëª…</div></div><div class="funnel-pct" style="color:var(--green-600)">100%</div></div>
    <div class="funnel-drop">â†“ ${100-pct}% ì´íƒˆ</div>
    <div class="funnel-step"><div class="funnel-label">ê²°ê³¼ DM ë°œì†¡</div><div class="funnel-bar-wrap"><div class="funnel-bar" style="width:${pct}%;background:var(--green-300)">${sent.toLocaleString()}ëª…</div></div><div class="funnel-pct" style="color:var(--green-500)">${pct}%</div></div>`;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Module 3: Scent Profile
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderScentCharts() {
  // Top scent counts
  const scentCounts = {};
  SCENT_LABELS.forEach(s => scentCounts[s] = 0);
  filteredDocs.forEach(d => {
    const ts = d.result?.top_scent;
    if (ts && scentCounts[ts] !== undefined) scentCounts[ts]++;
  });

  // Avg scores
  const scoreSums = {};
  const scoreCnts = {};
  SCENT_LABELS.forEach(s => { scoreSums[s] = 0; scoreCnts[s] = 0; });
  filteredDocs.forEach(d => {
    if (!d.scores) return;
    SCENT_LABELS.forEach(s => {
      if (d.scores[s] !== undefined) {
        scoreSums[s] += d.scores[s];
        scoreCnts[s]++;
      }
    });
  });

  // Pie
  destroyChart('scentPie');
  charts.scentPie = new Chart(document.getElementById('scentPie'), {
    type: 'doughnut',
    data: {
      labels: SCENT_DISPLAY,
      datasets: [{
        data: SCENT_LABELS.map(s => scentCounts[s]),
        backgroundColor: SCENT_COLORS,
        borderColor: '#fff',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      cutout: '55%',
      plugins: {
        legend: { position: 'bottom', labels: { padding: 14, font: { size: 11 } } }
      }
    }
  });

  // Bar
  destroyChart('scentBar');
  charts.scentBar = new Chart(document.getElementById('scentBar'), {
    type: 'bar',
    data: {
      labels: SCENT_DISPLAY,
      datasets: [{
        label: 'í‰ê·  ì ìˆ˜',
        data: SCENT_LABELS.map(s => scoreCnts[s] > 0 ? +(scoreSums[s] / scoreCnts[s]).toFixed(1) : 0),
        backgroundColor: SCENT_BG,
        borderColor: SCENT_COLORS,
        borderWidth: 1.5,
        borderRadius: 4
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: { grid: { color: '#e7e5e4' }, ticks: { color: '#a8a29e' }, max: 37.5 },
        x: { grid: { display: false }, ticks: { color: '#a8a29e', font: { size: 11 } } }
      },
      plugins: { legend: { display: false } }
    }
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Module 4: Product Matching
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CATEGORY_MAP = {
  'room_spray': 'ë£¸ ìŠ¤í”„ë ˆì´',
  'bedroom_candle': 'ì¹¨ì‹¤ ìº”ë“¤',
  'kitchen_candle': 'ì£¼ë°© ìº”ë“¤',
  'car_diffuser': 'ì°¨ëŸ‰ ë°©í–¥ì œ'
};

function renderProductCharts() {
  // Product counts
  const productCounts = {};
  const productNames = {};
  const productCats = {};
  filteredDocs.forEach(d => {
    const pid = d.result?.matched_product_id;
    const pname = d.result?.matched_product_name_en || d.result?.matched_product_name || pid;
    const cat = d.result?.category;
    if (pid) {
      productCounts[pid] = (productCounts[pid] || 0) + 1;
      productNames[pid] = pname;
      productCats[pid] = cat;
    }
  });

  const sorted = Object.entries(productCounts).sort((a, b) => b[1] - a[1]).slice(0, 10);

  destroyChart('productBar');
  charts.productBar = new Chart(document.getElementById('productBar'), {
    type: 'bar',
    data: {
      labels: sorted.map(([pid]) => productNames[pid] || pid),
      datasets: [{
        label: 'ë§¤ì¹­ íšŸìˆ˜',
        data: sorted.map(([, cnt]) => cnt),
        backgroundColor: sorted.map((_, i) => SCENT_BG[i % SCENT_BG.length]),
        borderColor: sorted.map((_, i) => SCENT_COLORS[i % SCENT_COLORS.length]),
        borderWidth: 1.5,
        borderRadius: 4
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true,
      scales: {
        x: { grid: { color: '#e7e5e4' }, ticks: { color: '#a8a29e' } },
        y: { grid: { display: false }, ticks: { color: '#a8a29e', font: { size: 11 } } }
      },
      plugins: { legend: { display: false } }
    }
  });

  // Category doughnut
  const catCounts = {};
  filteredDocs.forEach(d => {
    const cat = d.result?.category;
    if (cat) catCounts[cat] = (catCounts[cat] || 0) + 1;
  });
  const catKeys = Object.keys(CATEGORY_MAP);

  destroyChart('categoryDoughnut');
  charts.categoryDoughnut = new Chart(document.getElementById('categoryDoughnut'), {
    type: 'doughnut',
    data: {
      labels: catKeys.map(k => CATEGORY_MAP[k]),
      datasets: [{
        data: catKeys.map(k => catCounts[k] || 0),
        backgroundColor: SCENT_COLORS.slice(0, 4),
        borderColor: '#fff',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      cutout: '55%',
      plugins: {
        legend: { position: 'bottom', labels: { padding: 14, font: { size: 11 } } }
      }
    }
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Module 5: Demographics
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDemographics() {
  // Gender
  const genderCounts = {};
  filteredDocs.forEach(d => {
    const g = d.basic_info?.gender || 'unknown';
    genderCounts[g] = (genderCounts[g] || 0) + 1;
  });
  const genderLabels = { 'female': 'ì—¬ì„±', 'male': 'ë‚¨ì„±', 'non_binary': 'Non-binary', 'prefer_not_to_say': 'ë¯¸ì‘ë‹µ', 'unknown': 'ì•Œ ìˆ˜ ì—†ìŒ' };
  const genderKeys = Object.keys(genderCounts).sort();

  destroyChart('genderPie');
  charts.genderPie = new Chart(document.getElementById('genderPie'), {
    type: 'doughnut',
    data: {
      labels: genderKeys.map(k => genderLabels[k] || k),
      datasets: [{
        data: genderKeys.map(k => genderCounts[k]),
        backgroundColor: ['#d4a0b9', '#6ba3be', '#8b7bb5', '#a8a29e'],
        borderColor: '#fff',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      cutout: '55%',
      plugins: { legend: { position: 'bottom', labels: { font: { size: 11 } } } }
    }
  });

  // Age
  const ageCounts = {};
  filteredDocs.forEach(d => {
    const a = d.basic_info?.age_group || 'unknown';
    ageCounts[a] = (ageCounts[a] || 0) + 1;
  });
  const ageOrder = ['teens', '20s', '30s', '40s', '50s_plus', 'unknown'];
  const ageLabels = { 'teens': '10ëŒ€', '20s': '20ëŒ€', '30s': '30ëŒ€', '40s': '40ëŒ€', '50s_plus': '50ëŒ€+', 'unknown': 'ì•Œ ìˆ˜ ì—†ìŒ' };
  const ageKeys = ageOrder.filter(k => ageCounts[k]);

  destroyChart('agePie');
  charts.agePie = new Chart(document.getElementById('agePie'), {
    type: 'bar',
    data: {
      labels: ageKeys.map(k => ageLabels[k] || k),
      datasets: [{
        label: 'ì°¸ì—¬ì ìˆ˜',
        data: ageKeys.map(k => ageCounts[k] || 0),
        backgroundColor: '#4d9b7333',
        borderColor: '#4d9b73',
        borderWidth: 1.5,
        borderRadius: 4
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: { grid: { color: '#e7e5e4' }, ticks: { color: '#a8a29e' } },
        x: { grid: { display: false }, ticks: { color: '#a8a29e' } }
      },
      plugins: { legend: { display: false } }
    }
  });

  // Gender Ã— Scent
  const genderScent = {};
  filteredDocs.forEach(d => {
    const g = d.basic_info?.gender;
    const s = d.result?.top_scent;
    if (!g || !s) return;
    if (!genderScent[g]) genderScent[g] = {};
    genderScent[g][s] = (genderScent[g][s] || 0) + 1;
  });
  const mainGenders = ['female', 'male'].filter(g => genderScent[g]);

  destroyChart('genderScentBar');
  charts.genderScentBar = new Chart(document.getElementById('genderScentBar'), {
    type: 'bar',
    data: {
      labels: SCENT_DISPLAY,
      datasets: mainGenders.map((g, gi) => ({
        label: genderLabels[g] || g,
        data: SCENT_LABELS.map(s => genderScent[g]?.[s] || 0),
        backgroundColor: gi === 0 ? '#d4a0b944' : '#6ba3be44',
        borderColor: gi === 0 ? '#d4a0b9' : '#6ba3be',
        borderWidth: 1.5,
        borderRadius: 3
      }))
    },
    options: {
      responsive: true,
      scales: {
        y: { grid: { color: '#e7e5e4' }, ticks: { color: '#a8a29e' } },
        x: { grid: { display: false }, ticks: { color: '#a8a29e', font: { size: 9 } } }
      },
      plugins: { legend: { labels: { font: { size: 11 } } } }
    }
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Module 6: Space
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SPACE_LABELS = { 'living_bedroom': 'ê±°ì‹¤/ì¹¨ì‹¤', 'kitchen': 'ì£¼ë°©', 'car': 'ì°¨ëŸ‰' };

function renderSpace() {
  const spaceCounts = {};
  filteredDocs.forEach(d => {
    const s = d.selected_space;
    if (s) spaceCounts[s] = (spaceCounts[s] || 0) + 1;
  });
  const spaceKeys = Object.keys(SPACE_LABELS).filter(k => spaceCounts[k]);

  destroyChart('spacePie');
  charts.spacePie = new Chart(document.getElementById('spacePie'), {
    type: 'doughnut',
    data: {
      labels: spaceKeys.map(k => SPACE_LABELS[k]),
      datasets: [{
        data: spaceKeys.map(k => spaceCounts[k] || 0),
        backgroundColor: ['#4d9b73', '#c8875f', '#6ba3be'],
        borderColor: '#fff',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      cutout: '55%',
      plugins: { legend: { position: 'bottom', labels: { font: { size: 11 } } } }
    }
  });

  // Space Ã— Scent
  const spaceScent = {};
  filteredDocs.forEach(d => {
    const sp = d.selected_space;
    const sc = d.result?.top_scent;
    if (!sp || !sc) return;
    if (!spaceScent[sp]) spaceScent[sp] = {};
    spaceScent[sp][sc] = (spaceScent[sp][sc] || 0) + 1;
  });

  destroyChart('spaceBar');
  charts.spaceBar = new Chart(document.getElementById('spaceBar'), {
    type: 'bar',
    data: {
      labels: spaceKeys.map(k => SPACE_LABELS[k]),
      datasets: SCENT_LABELS.map((s, i) => ({
        label: SCENT_DISPLAY[i],
        data: spaceKeys.map(k => spaceScent[k]?.[s] || 0),
        backgroundColor: SCENT_BG[i],
        borderColor: SCENT_COLORS[i],
        borderWidth: 1.5,
        borderRadius: 3
      }))
    },
    options: {
      responsive: true,
      scales: {
        y: { stacked: true, grid: { color: '#e7e5e4' }, ticks: { color: '#a8a29e' } },
        x: { stacked: true, grid: { display: false } }
      },
      plugins: { legend: { labels: { font: { size: 10 } } } }
    }
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Module 7: Timeline
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTimeline() {
  const dailyCounts = {};
  filteredDocs.forEach(d => {
    if (!d.created_at) return;
    const dt = new Date(d.created_at);
    const key = dt.toISOString().split('T')[0];
    dailyCounts[key] = (dailyCounts[key] || 0) + 1;
  });

  const sorted = Object.entries(dailyCounts).sort((a, b) => a[0].localeCompare(b[0]));

  destroyChart('timelineChart');
  charts.timelineChart = new Chart(document.getElementById('timelineChart'), {
    type: 'line',
    data: {
      labels: sorted.map(([d]) => d.slice(5)), // MM-DD
      datasets: [{
        label: 'í€´ì¦ˆ ì™„ë£Œ',
        data: sorted.map(([, c]) => c),
        borderColor: '#2d7a52',
        backgroundColor: 'rgba(45,122,82,0.08)',
        fill: true,
        tension: 0.35,
        pointRadius: 3,
        pointBackgroundColor: '#2d7a52',
        pointBorderColor: '#fff',
        pointBorderWidth: 1.5
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: { grid: { color: '#e7e5e4' }, ticks: { color: '#a8a29e', stepSize: 1 }, beginAtZero: true },
        x: { grid: { display: false }, ticks: { color: '#a8a29e', font: { size: 11 }, maxRotation: 45 } }
      },
      plugins: { legend: { display: false } }
    }
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Module 8: Live Feed
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFeed() {
  const body = document.getElementById('feedBody');
  const recent = filteredDocs.slice(0, 50);

  if (recent.length === 0) {
    body.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--text3);padding:40px">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
    return;
  }

  const spaceLabel = { 'living_bedroom': 'ê±°ì‹¤/ì¹¨ì‹¤', 'kitchen': 'ì£¼ë°©', 'car': 'ì°¨ëŸ‰' };
  const genderLabel = { 'female': 'F', 'male': 'M', 'non_binary': 'NB', 'prefer_not_to_say': '-' };
  const scentEmoji = { 'FLORAL': 'ğŸŒ¸', 'GREEN': 'ğŸŒ²', 'FRESH': 'ğŸŒŠ', 'WOODY_INK': 'ğŸ–¤', 'WARMING': 'ğŸ”¥' };

  body.innerHTML = recent.map(d => {
    const time = d.created_at ? new Date(d.created_at).toLocaleString('ko-KR', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }) : '--';
    const subId = d.subscriber_id ? (d.subscriber_id.slice(0, 8) + '...') : '--';
    const gender = genderLabel[d.basic_info?.gender] || '--';
    const age = d.basic_info?.age_group || '--';
    const space = spaceLabel[d.selected_space] || '--';
    const scent = d.result?.top_scent || '--';
    const scentIcon = scentEmoji[scent] || '';
    const product = d.result?.matched_product_name_en || d.result?.matched_product_name || '--';
    const dmStatus = d.dm_sent
      ? '<span class="status-badge sent">âœ… ë°œì†¡</span>'
      : '<span class="status-badge pending">â³ ëŒ€ê¸°</span>';
    return `<tr>
      <td style="color:var(--text2);white-space:nowrap">${time}</td>
      <td><code style="font-size:.7rem;color:var(--accent)">${subId}</code></td>
      <td>${gender}</td>
      <td>${age}</td>
      <td>${space}</td>
      <td>${scentIcon} ${scent}</td>
      <td style="max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${product}</td>
      <td>${dmStatus}</td>
    </tr>`;
  }).join('');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Utils
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function destroyChart(key) {
  if (charts[key]) { charts[key].destroy(); delete charts[key]; }
}

function scrollTo(id) {
  document.getElementById(id)?.scrollIntoView({ behavior: 'smooth', block: 'start' });
  document.querySelectorAll('.sidebar nav a').forEach(a => a.classList.remove('active'));
  document.querySelector(`a[href="#${id}"]`)?.classList.add('active');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Init
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadData();

// Auto-refresh every 60 seconds
setInterval(loadData, 60000);
</script>
</body>
</html>
