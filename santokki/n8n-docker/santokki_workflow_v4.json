{
    "name": "Santokki - í–¥ ì¶”ì²œ DM ìë™í™” v4 (Firestore í´ë§)",
    "nodes": [
        {
            "parameters": {
                "rule": {
                    "interval": [
                        {
                            "field": "seconds",
                            "secondsInterval": 30
                        }
                    ]
                }
            },
            "id": "v4-node-001",
            "name": "30ì´ˆë§ˆë‹¤ ì‹¤í–‰",
            "type": "n8n-nodes-base.scheduleTrigger",
            "typeVersion": 1.2,
            "position": [
                240,
                300
            ]
        },
        {
            "parameters": {
                "jsCode": "// ============================================\n// Santokki v4 - Firestore ë¯¸ì²˜ë¦¬ ë¬¸ì„œ ì¡°íšŒ\n// Firebase REST API ì‚¬ìš© (Admin SDK ë¶ˆí•„ìš”)\n// ============================================\n\nconst FIREBASE_PROJECT_ID = 'santokki-f7c72';\nconst SERVICE_ACCOUNT_KEY = require('/home/node/.n8n/firebase-key.json');\n\n// Google OAuth2 í† í° ìƒì„±\nconst crypto = require('crypto');\nfunction base64url(str) {\n  return Buffer.from(str).toString('base64')\n    .replace(/\\+/g, '-').replace(/\\//g, '_').replace(/=+$/, '');\n}\n\nconst now = Math.floor(Date.now() / 1000);\nconst header = base64url(JSON.stringify({ alg: 'RS256', typ: 'JWT' }));\nconst payload = base64url(JSON.stringify({\n  iss: SERVICE_ACCOUNT_KEY.client_email,\n  scope: 'https://www.googleapis.com/auth/datastore',\n  aud: 'https://oauth2.googleapis.com/token',\n  exp: now + 3600,\n  iat: now\n}));\n\nconst sign = crypto.createSign('RSA-SHA256');\nsign.write(`${header}.${payload}`);\nsign.end();\nconst signature = sign.sign(SERVICE_ACCOUNT_KEY.private_key, 'base64')\n  .replace(/\\+/g, '-').replace(/\\//g, '_').replace(/=+$/, '');\n\nconst jwt = `${header}.${payload}.${signature}`;\n\n// 1. ì•¡ì„¸ìŠ¤ í† í° ë°œê¸‰\nconst tokenResponse = await this.helpers.httpRequest({\n  method: 'POST',\n  url: 'https://oauth2.googleapis.com/token',\n  headers: { 'Content-Type': 'application/x-www-form-urlencoded' },\n  body: `grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer&assertion=${jwt}`,\n  returnFullResponse: true\n});\n\nconst accessToken = tokenResponse.body.access_token;\nif (!accessToken) {\n  throw new Error('Google ì•¡ì„¸ìŠ¤ í† í° ë°œê¸‰ ì‹¤íŒ¨');\n}\n\n// 2. Firestoreì—ì„œ dm_sent == false ë¬¸ì„œ ì¡°íšŒ\nconst firestoreUrl = `https://firestore.googleapis.com/v1/projects/${FIREBASE_PROJECT_ID}/databases/(default)/documents:runQuery`;\n\nconst queryBody = {\n  structuredQuery: {\n    from: [{ collectionId: 'quiz_results' }],\n    where: {\n      fieldFilter: {\n        field: { fieldPath: 'dm_sent' },\n        op: 'EQUAL',\n        value: { booleanValue: false }\n      }\n    },\n    limit: 10\n  }\n};\n\nconst queryResponse = await this.helpers.httpRequest({\n  method: 'POST',\n  url: firestoreUrl,\n  headers: {\n    'Authorization': `Bearer ${accessToken}`,\n    'Content-Type': 'application/json'\n  },\n  body: queryBody,\n  json: true,\n  returnFullResponse: true\n});\n\nconst docs = queryResponse.body;\n\n// 3. ê²°ê³¼ íŒŒì‹±\nconst results = [];\nfor (const item of docs) {\n  if (!item.document) continue;\n  const doc = item.document;\n  const docId = doc.name.split('/').pop();\n  const fields = doc.fields || {};\n\n  const parseField = (f) => {\n    if (!f) return null;\n    if (f.stringValue !== undefined) return f.stringValue;\n    if (f.booleanValue !== undefined) return f.booleanValue;\n    if (f.integerValue !== undefined) return parseInt(f.integerValue);\n    if (f.doubleValue !== undefined) return f.doubleValue;\n    if (f.mapValue) {\n      const obj = {};\n      for (const [k, v] of Object.entries(f.mapValue.fields || {})) {\n        obj[k] = parseField(v);\n      }\n      return obj;\n    }\n    return null;\n  };\n\n  results.push({\n    json: {\n      _doc_id: docId,\n      _access_token: accessToken,\n      subscriber_id: parseField(fields.subscriber_id),\n      selected_space: parseField(fields.selected_space),\n      scores: parseField(fields.scores),\n      result: parseField(fields.result),\n      basic_info: parseField(fields.basic_info)\n    }\n  });\n}\n\nif (results.length === 0) {\n  return [];\n}\n\nreturn results;\n"
            },
            "id": "v4-node-002",
            "name": "Firestore ë¯¸ì²˜ë¦¬ ë¬¸ì„œ ì¡°íšŒ",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                480,
                300
            ]
        },
        {
            "parameters": {
                "jsCode": "// ============================================\n// Santokki v4 - ì œí’ˆ ë§¤ì¹­ ë…¸ë“œ (ìµœì‹  ë¼ì¸ì—…)\n// ============================================\n\nconst input = $input.item.json;\n\nconst subscriberId = input.subscriber_id || 'unknown';\nconst selectedSpace = input.selected_space || 'living_bedroom';\nconst scores = input.scores || {};\nconst result = input.result || {};\nconst accessToken = input._access_token;\nconst docId = input._doc_id;\n\n// ì œí’ˆ ë°ì´í„°ë² ì´ìŠ¤ (12ì¢… + ìê°œ Edition ì œì™¸)\nconst PRODUCTS = {\n  'RS-001': { name: 'ë‚¨ì‚°ì˜ ìƒˆë²½ ì•ˆê°œ', name_en: 'Morning Mist of Namsan', category: 'room_spray', shop_url: 'https://famous-pie-9e1a00.netlify.app/product.html?id=room-001', description_en: 'The mystical calm of dawn mist settling over Namsan\\'s pine forest â€” wet moss and cool earth.' },\n  'RS-002': { name: 'ì œì£¼ ì†Œê¸ˆê³¼ ë¯¼íŠ¸', name_en: 'Jeju Sea Salt & Mint', category: 'room_spray', shop_url: 'https://famous-pie-9e1a00.netlify.app/product.html?id=room-002', description_en: 'Cool sea breeze from Jeju\\'s volcanic shores â€” wild mint and eucalyptus over ocean salt.' },\n  'RS-003': { name: 'ê¸°ì™€ì˜ ê¸°ì–µ', name_en: 'Memory of Tiles', category: 'room_spray', shop_url: 'https://famous-pie-9e1a00.netlify.app/product.html?id=room-003', description_en: 'The earthy vitality rising from rain-soaked roof tiles and garden soil after a summer shower.' },\n  'BC-001': { name: 'ê³µì£¼ì˜ í™”ì›', name_en: 'The Princess\\'s Flower Garden', category: 'bedroom_candle', shop_url: 'https://famous-pie-9e1a00.netlify.app/product.html?id=candle-001', description_en: 'A royal garden in the rain â€” delicate peonies, pink pepper, and soft amber behind the palace walls.' },\n  'BC-002': { name: 'ë‚˜ì£¼ ë°°ê½ƒì˜ í–¥ì—°', name_en: 'Naju Pear Blossom', category: 'bedroom_candle', shop_url: 'https://famous-pie-9e1a00.netlify.app/product.html?id=candle-002', description_en: 'Pure sweetness of spring pear blossoms â€” white florals, freesia, and a touch of honey.' },\n  'BC-003': { name: 'ë‹¨ì²­ ì•„ë˜ ë¹—ì†Œë¦¬', name_en: 'Rain Under Dancheong', category: 'bedroom_candle', shop_url: 'https://famous-pie-9e1a00.netlify.app/product.html?id=candle-003', description_en: 'A serene rain-soaked hanok garden â€” wet cedar, wild flowers, and warm sandalwood.' },\n  'KC-004': { name: 'ì„¸ìì˜ ì„œì¬', name_en: 'The Crown Prince\\'s Study', category: 'kitchen_candle', shop_url: 'https://famous-pie-9e1a00.netlify.app/product.html?id=candle-006', description_en: 'A moonlit scholar\\'s study after rain â€” ink stone, bergamot, thyme, and distant pine.' },\n  'KC-001': { name: 'ìƒê°•ê³¼ ìœ ì', name_en: 'Ginger & Citron Warmth', category: 'kitchen_candle', shop_url: 'https://famous-pie-9e1a00.netlify.app/product.html?id=candle-004', description_en: 'Warm ginger-citron tea on a cold winter day â€” zesty yuzu, lemongrass, and golden honey.' },\n  'KC-002': { name: 'ì¡°ìš©í•œ ì°»ìë¦¬', name_en: 'A Quiet Tea Ceremony', category: 'kitchen_candle', shop_url: 'https://famous-pie-9e1a00.netlify.app/product.html?id=candle-005', description_en: 'Roasted grain and tea leaves â€” a calm, earthy moment of quiet conversation.' },\n  'CD-001': { name: 'í•œì§€ ìœ„ ë¨¹í–¥', name_en: 'Ink on Hanji', category: 'car_diffuser', shop_url: 'https://famous-pie-9e1a00.netlify.app/product.html?id=car-001', description_en: 'A scholar\\'s study â€” fresh ink on handmade Hanji paper, cedarwood, and cool metallic notes.' },\n  'CD-002': { name: 'í‘ì†¡ê³¼ í˜¸ë°•', name_en: 'Black Pine & Amber', category: 'car_diffuser', shop_url: 'https://famous-pie-9e1a00.netlify.app/product.html?id=car-002', description_en: 'Rugged black pine shaped by ocean winds â€” sandalwood, amber, and spicy herbs.' },\n  'CD-003': { name: 'ë¹„ì·¨ì˜ ë‚ ê°œ', name_en: 'Wings of Celadon', category: 'car_diffuser', shop_url: 'https://famous-pie-9e1a00.netlify.app/product.html?id=car-003', description_en: 'Where Goryeo celadon meets an English manor garden â€” green tea, plum blossom, bamboo leaf, and mossy cedarwood.' }\n};\n\nconst SCENT_PROFILES = {\n  FLORAL: { emoji: 'ğŸŒ¸', name_en: 'Floral', name_ko: 'í”Œë¡œëŸ´' },\n  GREEN: { emoji: 'ğŸŒ²', name_en: 'Green & Earthy', name_ko: 'ê·¸ë¦°/ì–´ì‹œ' },\n  FRESH: { emoji: 'ğŸŒŠ', name_en: 'Fresh', name_ko: 'í”„ë ˆì‹œ' },\n  WOODY_INK: { emoji: 'ğŸ–¤', name_en: 'Woody & Ink', name_ko: 'ìš°ë””/ì‰í¬' },\n  WARMING: { emoji: 'ğŸ”¥', name_en: 'Warming & Spicy', name_ko: 'ì›Œë°/ìŠ¤íŒŒì´ì‹œ' }\n};\n\nconst CATEGORY_NAMES = {\n  room_spray: { ko: 'ë£¸ ìŠ¤í”„ë ˆì´', en: 'Room Spray' },\n  bedroom_candle: { ko: 'ì¹¨ì‹¤ìš© ìº”ë“¤', en: 'Bedroom Candle' },\n  kitchen_candle: { ko: 'ì£¼ë°©ìš© ìº”ë“¤', en: 'Kitchen Candle' },\n  car_diffuser: { ko: 'ì°¨ëŸ‰ìš© ë°©í–¥ì œ', en: 'Car Diffuser' }\n};\n\nconst productId = result.matched_product_id;\nlet matchedProduct = PRODUCTS[productId] || PRODUCTS['BC-001'];\n\nconst topScent = result.top_scent || 'FLORAL';\nconst scentInfo = SCENT_PROFILES[topScent] || SCENT_PROFILES.FLORAL;\nconst categoryInfo = CATEGORY_NAMES[matchedProduct.category] || CATEGORY_NAMES.bedroom_candle;\n\nreturn [{ json: {\n  _doc_id: docId,\n  _access_token: accessToken,\n  subscriber_id: subscriberId,\n  selected_space: selectedSpace,\n  scores: scores,\n  top_scent: topScent,\n  scent_info: scentInfo,\n  matched_product: {\n    id: productId,\n    name: matchedProduct.name,\n    name_en: matchedProduct.name_en,\n    category: matchedProduct.category,\n    category_ko: categoryInfo.ko,\n    category_en: categoryInfo.en,\n    shop_url: matchedProduct.shop_url,\n    description_en: matchedProduct.description_en\n  }\n} }];\n"
            },
            "id": "v4-node-003",
            "name": "ì œí’ˆ ë§¤ì¹­",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                720,
                300
            ]
        },
        {
            "parameters": {
                "jsCode": "// ============================================\n// Santokki v4 - í”„ë¡œëª¨ì½”ë“œ ìƒì„± + DM ë©”ì‹œì§€ ì¡°í•©\n// ============================================\n\nconst data = $input.item.json;\n\nconst chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';\nlet randomPart = '';\nfor (let i = 0; i < 4; i++) {\n  randomPart += chars.charAt(Math.floor(Math.random() * chars.length));\n}\nconst promoCode = `SANTOKKI-${randomPart}-15OFF`;\n\nconst emoji = data.scent_info.emoji;\nconst scentName = data.scent_info.name_en;\nconst shopUrl = data.matched_product.shop_url;\n\nconst dmMessage = `ğŸ° Your Santokki Scent Quiz result is ready!\\n\\n` +\n  `Your perfect fragrance match is...\\n\\n` +\n  `${emoji} ${data.matched_product.name_en} ${emoji}\\n` +\n  `${data.matched_product.name}\\n\\n` +\n  `ğŸ·ï¸ ${data.matched_product.category_en}\\n` +\n  `ğŸ’¬ ${data.matched_product.description_en}\\n\\n` +\n  `Your scent profile: ${scentName}\\n\\n` +\n  `ğŸ›’ Shop now:\\n` +\n  `${shopUrl}\\n\\n` +\n  `ğŸ First order discount!\\n` +\n  `Use code: ${promoCode}\\n` +\n  `Get 15% off your purchase ğŸ’•\\n\\n` +\n  `ğŸ“¢ Want monthly exclusive offers? Reply \"YES\" to subscribe! ğŸ””`;\n\nreturn [{ json: {\n  _doc_id: data._doc_id,\n  _access_token: data._access_token,\n  subscriber_id: data.subscriber_id,\n  matched_product: data.matched_product,\n  scent_info: data.scent_info,\n  promo_code: promoCode,\n  dm_message: dmMessage\n} }];\n"
            },
            "id": "v4-node-004",
            "name": "í”„ë¡œëª¨ì½”ë“œ ìƒì„± + ë©”ì‹œì§€ ì¡°í•©",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                960,
                300
            ]
        },
        {
            "parameters": {
                "jsCode": "// ============================================\n// Santokki v4 - ManyChat DM ë°œì†¡\n// ============================================\n\nconst data = $input.item.json;\nconst MANYCHAT_API_KEY = '4433599:c69bab2399cb2e3b7ff0990b6028298b';\n\n// subscriber_idë¥¼ ìˆ«ìë¡œ ë³€í™˜ (ManyChat ìš”êµ¬ì‚¬í•­)\nconst subId = parseInt(data.subscriber_id, 10);\n\nconst body = {\n  subscriber_id: subId,\n  data: {\n    version: 'v2',\n    content: {\n      messages: [\n        {\n          type: 'text',\n          text: data.dm_message\n        }\n      ]\n    }\n  }\n};\n\nlet dmSuccess = false;\nlet dmError = null;\nlet dmResponse = null;\n\ntry {\n  const response = await this.helpers.httpRequest({\n    method: 'POST',\n    url: 'https://api.manychat.com/ig/sending/sendContent',\n    headers: {\n      'Authorization': `Bearer ${MANYCHAT_API_KEY}`,\n      'Content-Type': 'application/json',\n      'Accept': 'application/json'\n    },\n    body: body,\n    json: true,\n    returnFullResponse: true\n  });\n  dmResponse = response.body;\n  dmSuccess = response.statusCode >= 200 && response.statusCode < 300;\n  if (!dmSuccess) {\n    dmError = JSON.stringify(response.body);\n  }\n} catch (error) {\n  dmError = error.message;\n  if (error.response) {\n    dmError += ' | Response: ' + JSON.stringify(error.response.body || error.response.data || '');\n  }\n}\n\nreturn [{ json: {\n  _doc_id: data._doc_id,\n  _access_token: data._access_token,\n  subscriber_id: subId,\n  matched_product: data.matched_product,\n  scent_info: data.scent_info,\n  promo_code: data.promo_code,\n  dm_success: dmSuccess,\n  dm_error: dmError,\n  dm_response: dmResponse\n} }];\n"
            },
            "id": "v4-node-005",
            "name": "ManyChat DM ë°œì†¡",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                1200,
                300
            ]
        },
        {
            "parameters": {
                "jsCode": "// ============================================\n// Santokki v4 - Firestore ì²˜ë¦¬ì™„ë£Œ í‘œì‹œ\n// dm_sent: true, dm_sent_at: timestamp ì—…ë°ì´íŠ¸\n// ============================================\n\nconst data = $input.item.json;\nconst FIREBASE_PROJECT_ID = 'santokki-f7c72';\nconst docId = data._doc_id;\nconst accessToken = data._access_token;\n\nconst updateUrl = `https://firestore.googleapis.com/v1/projects/${FIREBASE_PROJECT_ID}/databases/(default)/documents/quiz_results/${docId}?updateMask.fieldPaths=dm_sent&updateMask.fieldPaths=dm_sent_at&updateMask.fieldPaths=promo_code&updateMask.fieldPaths=matched_product_id&updateMask.fieldPaths=matched_product_name`;\n\nconst now = new Date().toISOString();\n\nconst updateBody = {\n  fields: {\n    dm_sent: { booleanValue: true },\n    dm_sent_at: { stringValue: now },\n    promo_code: { stringValue: data.promo_code },\n    matched_product_id: { stringValue: data.matched_product.id || '' },\n    matched_product_name: { stringValue: data.matched_product.name_en || '' }\n  }\n};\n\ntry {\n  await this.helpers.httpRequest({\n    method: 'PATCH',\n    url: updateUrl,\n    headers: {\n      'Authorization': `Bearer ${accessToken}`,\n      'Content-Type': 'application/json'\n    },\n    body: updateBody,\n    json: true\n  });\n} catch (error) {\n  // Firestore ì—…ë°ì´íŠ¸ ì‹¤íŒ¨í•´ë„ ë¡œê·¸ë§Œ ë‚¨ê¸°ê³  ê³„ì† ì§„í–‰\n  console.error('Firestore update failed:', error.message);\n}\n\nreturn [{ json: {\n  status: data.dm_success ? 'ok' : 'dm_failed',\n  subscriber_id: data.subscriber_id,\n  product: data.matched_product.name_en,\n  scent_profile: data.scent_info.name_en,\n  promo_code: data.promo_code,\n  dm_sent: data.dm_success,\n  dm_error: data.dm_error || null\n} }];\n"
            },
            "id": "v4-node-006",
            "name": "Firestore ì²˜ë¦¬ì™„ë£Œ ì—…ë°ì´íŠ¸",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                1440,
                300
            ]
        }
    ],
    "connections": {
        "30ì´ˆë§ˆë‹¤ ì‹¤í–‰": {
            "main": [
                [
                    {
                        "node": "Firestore ë¯¸ì²˜ë¦¬ ë¬¸ì„œ ì¡°íšŒ",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Firestore ë¯¸ì²˜ë¦¬ ë¬¸ì„œ ì¡°íšŒ": {
            "main": [
                [
                    {
                        "node": "ì œí’ˆ ë§¤ì¹­",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "ì œí’ˆ ë§¤ì¹­": {
            "main": [
                [
                    {
                        "node": "í”„ë¡œëª¨ì½”ë“œ ìƒì„± + ë©”ì‹œì§€ ì¡°í•©",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "í”„ë¡œëª¨ì½”ë“œ ìƒì„± + ë©”ì‹œì§€ ì¡°í•©": {
            "main": [
                [
                    {
                        "node": "ManyChat DM ë°œì†¡",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "ManyChat DM ë°œì†¡": {
            "main": [
                [
                    {
                        "node": "Firestore ì²˜ë¦¬ì™„ë£Œ ì—…ë°ì´íŠ¸",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    },
    "active": false,
    "settings": {
        "executionOrder": "v1"
    },
    "tags": []
}